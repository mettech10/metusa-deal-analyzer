From abe6c7e8d6d67554f2c45e211f2917e0bbffc529 Mon Sep 17 00:00:00 2001
From: Claude <noreply@anthropic.com>
Date: Sat, 28 Feb 2026 18:20:04 +0000
Subject: [PATCH] feat: saved analysis history + paddle sandbox fix
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

## Recent Deals (per-user saved analyses)

Analyses are auto-saved to Supabase after every AI analysis
completes. Logged-in users see a "Recent Deals" grid on the
analyse page showing their previous deals with key metrics and
a three-dot menu to delete entries.

Files added:
- supabase/migrations/20260228000000_create_saved_analyses.sql
  · saved_analyses table with RLS (users see/delete only own rows)
  · columns: address, postcode, investment_type, purchase_price,
    deal_score, monthly_cashflow, annual_cashflow, gross_yield,
    form_data (jsonb), results (jsonb), ai_text

- app/api/analyses/route.ts — GET (list) + POST (save)
- app/api/analyses/[id]/route.ts — DELETE (remove own record)

- components/analyse/recent-deals.tsx
  · Card grid: strategy badge, address, score ring, monthly
    cashflow, gross yield, purchase price, date
  · MoreVertical three-dot dropdown → Delete
  · Skeleton loading state; hides itself when no saved deals
  · Hover-triggered menu (opacity-0 → opacity-100)

- app/analyse/page.tsx
  · imports RecentDeals, useEffect, useRef
  · auto-save useEffect fires when aiLoading flips false and
    aiText + formData are present; deduped with savedKeyRef
  · recentDealsVersion state forces RecentDeals re-fetch after save
  · <RecentDeals> shown above input when !hasResults && !isProcessing
  · resetAll() clears savedKeyRef so same address can be re-saved

## Paddle sandbox fix

lib/paddle.ts:
  · Added _paddleToken to detect stale singleton across hot-reloads
  · Singleton resets when token changes (new deploy, env update)
  · Improved console.warn explains NEXT_PUBLIC_ build-time baking:
    "If you just added it to Render, trigger a new deploy"

⚠️  ACTION REQUIRED (one-time Supabase setup):
Run supabase/migrations/20260228000000_create_saved_analyses.sql
in Supabase Dashboard → SQL Editor before deploying.

⚠️  ACTION REQUIRED (Paddle):
After setting NEXT_PUBLIC_PADDLE_CLIENT_TOKEN and
NEXT_PUBLIC_PADDLE_ENV on Render, trigger a manual redeploy
so the values are baked into the Next.js bundle.

https://claude.ai/code/session_01WYRuFL36VPp66p8p86K5sq
---
 app/analyse/page.tsx                          |  57 ++++-
 app/api/analyses/[id]/route.ts                |  33 +++
 app/api/analyses/route.ts                     |  93 ++++++++
 components/analyse/recent-deals.tsx           | 211 ++++++++++++++++++
 lib/paddle.ts                                 |  24 +-
 .../20260228000000_create_saved_analyses.sql  |  50 +++++
 6 files changed, 464 insertions(+), 4 deletions(-)
 create mode 100644 app/api/analyses/[id]/route.ts
 create mode 100644 app/api/analyses/route.ts
 create mode 100644 components/analyse/recent-deals.tsx
 create mode 100644 supabase/migrations/20260228000000_create_saved_analyses.sql

diff --git a/app/analyse/page.tsx b/app/analyse/page.tsx
index ed0f08b..bc0cdc0 100644
--- a/app/analyse/page.tsx
+++ b/app/analyse/page.tsx
@@ -1,6 +1,6 @@
 "use client"
 
-import { useState, useCallback } from "react"
+import { useState, useCallback, useEffect, useRef } from "react"
 
 // Helper to format analysis results from backend
 function formatAnalysisResults(r: Record<string, any>): string {
@@ -192,6 +192,7 @@ import { Button } from "@/components/ui/button"
 import { Input } from "@/components/ui/input"
 import { PropertyForm } from "@/components/analyse/property-form"
 import { AnalysisResults } from "@/components/analyse/analysis-results"
+import { RecentDeals } from "@/components/analyse/recent-deals"
 import { calculateAll } from "@/lib/calculations"
 import type { PropertyFormData, CalculationResults } from "@/lib/types"
 import {
@@ -437,6 +438,52 @@ export default function AnalysePage() {
     [listingUrl]
   )
 
+  // Track last-saved analysis so we don't double-save on re-renders
+  const savedKeyRef = useRef<string | null>(null)
+  // Ref to always have the latest aiText synchronously in effects
+  const aiTextRef = useRef("")
+  useEffect(() => { aiTextRef.current = aiText }, [aiText])
+
+  // Auto-save to Supabase after AI analysis finishes (aiLoading → false with content)
+  const [recentDealsVersion, setRecentDealsVersion] = useState(0)
+  useEffect(() => {
+    // Only fire when AI loading just completed and we have data
+    if (aiLoading || !aiText || !formData) return
+
+    // Build a unique key for this analysis to prevent double-saves
+    const key = `${formData.address}|${formData.purchasePrice}|${aiText.length}`
+    if (savedKeyRef.current === key) return
+    savedKeyRef.current = key
+
+    // Extract score from AI text
+    const scoreMatch = aiText.match(/SCORE:\s*(\d+)/i) || aiText.match(/⭐ SCORE:\s*(\d+)/i)
+    const dealScore = scoreMatch ? parseInt(scoreMatch[1]) : null
+
+    fetch("/api/analyses", {
+      method: "POST",
+      headers: { "Content-Type": "application/json" },
+      body: JSON.stringify({
+        address: formData.address || "Unknown",
+        postcode: formData.postcode || null,
+        investment_type: formData.investmentType || "btl",
+        purchase_price: formData.purchasePrice || 0,
+        deal_score: dealScore,
+        monthly_cashflow: results?.monthlyCashFlow ?? null,
+        annual_cashflow: results?.annualCashFlow ?? null,
+        gross_yield: results?.grossYield ?? null,
+        form_data: formData,
+        results: results,
+        ai_text: aiText,
+      }),
+    })
+      .then((r) => {
+        if (r.ok) setRecentDealsVersion((v) => v + 1)
+      })
+      .catch(() => {
+        // Not logged in or DB error — silently skip, saving is best-effort
+      })
+  }, [aiLoading]) // eslint-disable-line react-hooks/exhaustive-deps
+
   const hasResults = (results && formData) || aiText
   const isProcessing = isLoading || aiLoading
 
@@ -448,6 +495,7 @@ export default function AnalysePage() {
     setAiText("")
     setPrefillData(null)
     setScrapedFromUrl(false)
+    savedKeyRef.current = null
   }
 
   const handleSavePDF = () => {
@@ -895,6 +943,13 @@ export default function AnalysePage() {
           </p>
         </div>
 
+        {/* Recent Deals — shown only when not viewing a current analysis */}
+        {!hasResults && !isProcessing && (
+          <div className="mb-8">
+            <RecentDeals key={recentDealsVersion} />
+          </div>
+        )}
+
         {/* Input Mode Selector -- hidden once we have results */}
         {!hasResults && (
           <div className="mb-8 flex max-w-lg rounded-lg border border-border/50 bg-card p-1">
diff --git a/app/api/analyses/[id]/route.ts b/app/api/analyses/[id]/route.ts
new file mode 100644
index 0000000..4ee0a65
--- /dev/null
+++ b/app/api/analyses/[id]/route.ts
@@ -0,0 +1,33 @@
+import { createClient } from "@/lib/supabase/server"
+import { NextResponse } from "next/server"
+
+// DELETE /api/analyses/[id] — delete a saved analysis owned by the logged-in user
+export async function DELETE(
+  _req: Request,
+  { params }: { params: Promise<{ id: string }> }
+) {
+  const { id } = await params
+  const supabase = await createClient()
+
+  const {
+    data: { user },
+    error: authError,
+  } = await supabase.auth.getUser()
+
+  if (authError || !user) {
+    return NextResponse.json({ error: "Unauthorised" }, { status: 401 })
+  }
+
+  const { error } = await supabase
+    .from("saved_analyses")
+    .delete()
+    .eq("id", id)
+    .eq("user_id", user.id) // RLS double-check — only delete own records
+
+  if (error) {
+    console.error("[DELETE /api/analyses]", error)
+    return NextResponse.json({ error: error.message }, { status: 500 })
+  }
+
+  return new Response(null, { status: 204 })
+}
diff --git a/app/api/analyses/route.ts b/app/api/analyses/route.ts
new file mode 100644
index 0000000..e93cba6
--- /dev/null
+++ b/app/api/analyses/route.ts
@@ -0,0 +1,93 @@
+import { createClient } from "@/lib/supabase/server"
+import { NextResponse } from "next/server"
+
+// GET /api/analyses — fetch the logged-in user's saved analyses
+export async function GET() {
+  const supabase = await createClient()
+
+  const {
+    data: { user },
+    error: authError,
+  } = await supabase.auth.getUser()
+
+  if (authError || !user) {
+    return NextResponse.json({ error: "Unauthorised" }, { status: 401 })
+  }
+
+  const { data, error } = await supabase
+    .from("saved_analyses")
+    .select(
+      "id, created_at, address, postcode, investment_type, purchase_price, deal_score, monthly_cashflow, annual_cashflow, gross_yield"
+    )
+    .eq("user_id", user.id)
+    .order("created_at", { ascending: false })
+    .limit(20)
+
+  if (error) {
+    console.error("[GET /api/analyses]", error)
+    return NextResponse.json({ error: error.message }, { status: 500 })
+  }
+
+  return NextResponse.json({ analyses: data })
+}
+
+// POST /api/analyses — save a new analysis for the logged-in user
+export async function POST(req: Request) {
+  const supabase = await createClient()
+
+  const {
+    data: { user },
+    error: authError,
+  } = await supabase.auth.getUser()
+
+  if (authError || !user) {
+    return NextResponse.json({ error: "Unauthorised" }, { status: 401 })
+  }
+
+  let body: Record<string, unknown>
+  try {
+    body = await req.json()
+  } catch {
+    return NextResponse.json({ error: "Invalid JSON" }, { status: 400 })
+  }
+
+  const {
+    address,
+    postcode,
+    investment_type,
+    purchase_price,
+    deal_score,
+    monthly_cashflow,
+    annual_cashflow,
+    gross_yield,
+    form_data,
+    results,
+    ai_text,
+  } = body
+
+  const { data, error } = await supabase
+    .from("saved_analyses")
+    .insert({
+      user_id: user.id,
+      address,
+      postcode,
+      investment_type,
+      purchase_price,
+      deal_score,
+      monthly_cashflow,
+      annual_cashflow,
+      gross_yield,
+      form_data,
+      results,
+      ai_text,
+    })
+    .select("id")
+    .single()
+
+  if (error) {
+    console.error("[POST /api/analyses]", error)
+    return NextResponse.json({ error: error.message }, { status: 500 })
+  }
+
+  return NextResponse.json({ id: data.id }, { status: 201 })
+}
diff --git a/components/analyse/recent-deals.tsx b/components/analyse/recent-deals.tsx
new file mode 100644
index 0000000..22594e8
--- /dev/null
+++ b/components/analyse/recent-deals.tsx
@@ -0,0 +1,211 @@
+"use client"
+
+import { useEffect, useState, useCallback } from "react"
+import { MoreVertical, Trash2, TrendingUp, Calendar, MapPin } from "lucide-react"
+import { Button } from "@/components/ui/button"
+import {
+  DropdownMenu,
+  DropdownMenuContent,
+  DropdownMenuItem,
+  DropdownMenuTrigger,
+} from "@/components/ui/dropdown-menu"
+
+interface SavedAnalysis {
+  id: string
+  created_at: string
+  address: string
+  postcode: string | null
+  investment_type: string
+  purchase_price: number
+  deal_score: number | null
+  monthly_cashflow: number | null
+  annual_cashflow: number | null
+  gross_yield: number | null
+}
+
+const strategyLabel: Record<string, string> = {
+  btl: "BTL",
+  brr: "BRR",
+  hmo: "HMO",
+  flip: "Flip",
+  r2sa: "R2SA",
+  development: "Dev",
+}
+
+const strategyColor: Record<string, string> = {
+  btl: "bg-blue-100 text-blue-700",
+  brr: "bg-purple-100 text-purple-700",
+  hmo: "bg-orange-100 text-orange-700",
+  flip: "bg-red-100 text-red-700",
+  r2sa: "bg-green-100 text-green-700",
+  development: "bg-yellow-100 text-yellow-700",
+}
+
+function scoreColor(score: number | null) {
+  if (score === null) return "text-muted-foreground"
+  if (score >= 75) return "text-green-600"
+  if (score >= 50) return "text-blue-600"
+  if (score >= 25) return "text-amber-600"
+  return "text-red-600"
+}
+
+function formatCurrency(n: number | null) {
+  if (n === null || n === undefined) return "—"
+  return `£${Math.round(n).toLocaleString("en-GB")}`
+}
+
+export function RecentDeals() {
+  const [analyses, setAnalyses] = useState<SavedAnalysis[]>([])
+  const [loading, setLoading] = useState(true)
+  const [deletingId, setDeletingId] = useState<string | null>(null)
+
+  const fetchAnalyses = useCallback(async () => {
+    try {
+      const res = await fetch("/api/analyses")
+      if (!res.ok) {
+        // Not logged in or no analyses — silently hide the section
+        setAnalyses([])
+        return
+      }
+      const data = await res.json()
+      setAnalyses(data.analyses || [])
+    } catch {
+      setAnalyses([])
+    } finally {
+      setLoading(false)
+    }
+  }, [])
+
+  useEffect(() => {
+    fetchAnalyses()
+  }, [fetchAnalyses])
+
+  const handleDelete = async (id: string) => {
+    setDeletingId(id)
+    try {
+      const res = await fetch(`/api/analyses/${id}`, { method: "DELETE" })
+      if (res.ok || res.status === 204) {
+        setAnalyses((prev) => prev.filter((a) => a.id !== id))
+      }
+    } finally {
+      setDeletingId(null)
+    }
+  }
+
+  if (loading) {
+    return (
+      <div className="space-y-3">
+        <div className="h-4 w-32 rounded bg-muted animate-pulse" />
+        <div className="grid gap-3 sm:grid-cols-2 lg:grid-cols-3">
+          {[1, 2, 3].map((i) => (
+            <div key={i} className="h-32 rounded-xl border border-border/50 bg-muted/30 animate-pulse" />
+          ))}
+        </div>
+      </div>
+    )
+  }
+
+  if (analyses.length === 0) return null
+
+  return (
+    <div className="space-y-3">
+      <div className="flex items-center gap-2">
+        <TrendingUp className="size-4 text-primary" />
+        <h2 className="text-sm font-semibold text-foreground">Recent Deals</h2>
+        <span className="ml-auto text-xs text-muted-foreground">{analyses.length} saved</span>
+      </div>
+
+      <div className="grid gap-3 sm:grid-cols-2 lg:grid-cols-3">
+        {analyses.map((deal) => (
+          <div
+            key={deal.id}
+            className="group relative rounded-xl border border-border/50 bg-card p-4 shadow-sm transition-shadow hover:shadow-md"
+          >
+            {/* Top row: strategy badge + three-dot menu */}
+            <div className="mb-2 flex items-start justify-between gap-2">
+              <span
+                className={`inline-flex items-center rounded-md px-2 py-0.5 text-xs font-semibold ${
+                  strategyColor[deal.investment_type] || "bg-muted text-muted-foreground"
+                }`}
+              >
+                {strategyLabel[deal.investment_type] || deal.investment_type.toUpperCase()}
+              </span>
+
+              <DropdownMenu>
+                <DropdownMenuTrigger asChild>
+                  <Button
+                    variant="ghost"
+                    size="icon"
+                    className="size-6 opacity-0 group-hover:opacity-100 transition-opacity"
+                    disabled={deletingId === deal.id}
+                  >
+                    <MoreVertical className="size-3.5" />
+                  </Button>
+                </DropdownMenuTrigger>
+                <DropdownMenuContent align="end">
+                  <DropdownMenuItem
+                    className="text-destructive focus:text-destructive"
+                    onClick={() => handleDelete(deal.id)}
+                  >
+                    <Trash2 className="mr-2 size-3.5" />
+                    Delete
+                  </DropdownMenuItem>
+                </DropdownMenuContent>
+              </DropdownMenu>
+            </div>
+
+            {/* Address */}
+            <div className="mb-3">
+              <div className="flex items-start gap-1.5">
+                <MapPin className="mt-0.5 size-3 shrink-0 text-muted-foreground" />
+                <p className="line-clamp-2 text-xs font-medium text-foreground leading-snug">
+                  {deal.address}
+                  {deal.postcode ? `, ${deal.postcode}` : ""}
+                </p>
+              </div>
+            </div>
+
+            {/* Metrics row */}
+            <div className="grid grid-cols-3 gap-1 mb-3">
+              <div className="text-center">
+                <p className={`text-sm font-bold tabular-nums ${scoreColor(deal.deal_score)}`}>
+                  {deal.deal_score !== null ? `${deal.deal_score}` : "—"}
+                </p>
+                <p className="text-[10px] text-muted-foreground">Score</p>
+              </div>
+              <div className="text-center">
+                <p className={`text-sm font-bold tabular-nums ${
+                  (deal.monthly_cashflow ?? 0) >= 0 ? "text-green-600" : "text-red-600"
+                }`}>
+                  {formatCurrency(deal.monthly_cashflow)}<span className="text-[9px] font-normal">/mo</span>
+                </p>
+                <p className="text-[10px] text-muted-foreground">Cash Flow</p>
+              </div>
+              <div className="text-center">
+                <p className="text-sm font-bold tabular-nums text-foreground">
+                  {deal.gross_yield !== null ? `${deal.gross_yield.toFixed(1)}%` : "—"}
+                </p>
+                <p className="text-[10px] text-muted-foreground">Yield</p>
+              </div>
+            </div>
+
+            {/* Footer */}
+            <div className="flex items-center justify-between border-t border-border/40 pt-2">
+              <p className="text-[10px] text-muted-foreground">
+                {formatCurrency(deal.purchase_price)}
+              </p>
+              <div className="flex items-center gap-1 text-[10px] text-muted-foreground">
+                <Calendar className="size-2.5" />
+                {new Date(deal.created_at).toLocaleDateString("en-GB", {
+                  day: "numeric",
+                  month: "short",
+                  year: "numeric",
+                })}
+              </div>
+            </div>
+          </div>
+        ))}
+      </div>
+    </div>
+  )
+}
diff --git a/lib/paddle.ts b/lib/paddle.ts
index 1a5bdc0..660ba23 100644
--- a/lib/paddle.ts
+++ b/lib/paddle.ts
@@ -2,21 +2,39 @@
 
 import { type Paddle, initializePaddle } from '@paddle/paddle-js'
 
+// Singleton — reset if the token changes between hot-reloads / deploys
 let _paddle: Paddle | undefined
+let _paddleToken: string | undefined
 
 /**
  * Returns a singleton Paddle instance initialised for the correct environment.
  * Call this inside a useEffect or event handler (never at module-load time).
+ *
+ * ⚠️  RENDER / PRODUCTION NOTE:
+ * NEXT_PUBLIC_* variables are baked into the JS bundle at BUILD time.
+ * If you set them in the Render dashboard after a previous deploy, you MUST
+ * trigger a new manual deploy so they get embedded into the new bundle.
+ * Render Dashboard → Manual Deploy → Deploy latest commit
  */
 export async function getPaddle(): Promise<Paddle | undefined> {
-  if (_paddle) return _paddle
-
   const token = process.env.NEXT_PUBLIC_PADDLE_CLIENT_TOKEN
+
   if (!token) {
-    console.warn('[Paddle] NEXT_PUBLIC_PADDLE_CLIENT_TOKEN is not set.')
+    console.warn(
+      '[Paddle] NEXT_PUBLIC_PADDLE_CLIENT_TOKEN is not set. ' +
+      'If you just added it to Render, trigger a new deploy — ' +
+      'NEXT_PUBLIC_ vars are baked into the bundle at build time.'
+    )
     return undefined
   }
 
+  // Return cached instance only if the token hasn't changed
+  if (_paddle && _paddleToken === token) return _paddle
+
+  // Reset stale singleton (e.g. after a new deploy / hot-reload changes token)
+  _paddle = undefined
+  _paddleToken = token
+
   const env = process.env.NEXT_PUBLIC_PADDLE_ENV === 'production'
     ? 'production'
     : 'sandbox'
diff --git a/supabase/migrations/20260228000000_create_saved_analyses.sql b/supabase/migrations/20260228000000_create_saved_analyses.sql
new file mode 100644
index 0000000..796f052
--- /dev/null
+++ b/supabase/migrations/20260228000000_create_saved_analyses.sql
@@ -0,0 +1,50 @@
+-- ──────────────────────────────────────────────────────────────────────────────
+-- Migration: create saved_analyses table
+-- Run this in: Supabase Dashboard → SQL Editor → New Query → Run
+-- ──────────────────────────────────────────────────────────────────────────────
+
+create table if not exists public.saved_analyses (
+  id              uuid primary key default gen_random_uuid(),
+  user_id         uuid not null references auth.users(id) on delete cascade,
+  created_at      timestamptz not null default now(),
+
+  -- Summary columns (shown on the Recent Deals cards)
+  address         text not null,
+  postcode        text,
+  investment_type text not null default 'btl',
+  purchase_price  numeric(12,2),
+  deal_score      integer,
+  monthly_cashflow  numeric(10,2),
+  annual_cashflow   numeric(10,2),
+  gross_yield       numeric(6,2),
+
+  -- Full data for future "reload this deal" feature
+  form_data       jsonb,
+  results         jsonb,
+  ai_text         text
+);
+
+-- Index for fast user-scoped lookups ordered by recency
+create index if not exists saved_analyses_user_id_created_at_idx
+  on public.saved_analyses (user_id, created_at desc);
+
+-- ── Row Level Security ───────────────────────────────────────────────────────
+alter table public.saved_analyses enable row level security;
+
+-- Users can only read their own analyses
+create policy "Users can view own analyses"
+  on public.saved_analyses
+  for select
+  using (auth.uid() = user_id);
+
+-- Users can only insert analyses linked to themselves
+create policy "Users can insert own analyses"
+  on public.saved_analyses
+  for insert
+  with check (auth.uid() = user_id);
+
+-- Users can only delete their own analyses
+create policy "Users can delete own analyses"
+  on public.saved_analyses
+  for delete
+  using (auth.uid() = user_id);
-- 
2.43.0

