From cd1d2be1ba61490eaa509bf4e239b6838f840958 Mon Sep 17 00:00:00 2001
From: Claude <noreply@anthropic.com>
Date: Sat, 28 Feb 2026 14:37:50 +0000
Subject: [PATCH] feat: circular deal score at top + sqm scraping + auto refurb
 budget
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

- Replace semicircular gauge with full-circle SVG progress ring showing XX%
  in the centre; score displayed prominently at the very top of results
  (above key metrics) so it's the first thing the user sees
- Add floor area (sqm/sq ft) extraction in Jina scraper – regex picks up
  "85 m²", "85 sqm", "915 sq ft" etc. and normalises to m²
- Pass scraped sqm back through Next.js scrape-only route → pre-fills sqm
  field in the property form when scraping a listing URL
- Add estimateRefurbCost() helper (lib/calculations.ts): calculates refurb
  budget from sqm × condition-rate × property-type and London multiplier
  (excellent=£0, good=£40/m², fair=£100/m², needs-work=£185/m²)
- Auto-populate Refurbishment Budget field in property-form when sqm and
  condition are set (only if field is still 0, so manual entries are kept)

https://claude.ai/code/session_01WYRuFL36VPp66p8p86K5sq
---
 app/api/analyse/route.ts                |  2 +
 components/analyse/analysis-results.tsx | 14 ++--
 components/analyse/deal-score.tsx       | 94 +++++++++++++------------
 components/analyse/property-form.tsx    | 23 +++++-
 lib/calculations.ts                     | 40 +++++++++++
 5 files changed, 120 insertions(+), 53 deletions(-)

diff --git a/app/api/analyse/route.ts b/app/api/analyse/route.ts
index e64b85a..ee2a1db 100644
--- a/app/api/analyse/route.ts
+++ b/app/api/analyse/route.ts
@@ -109,6 +109,7 @@ export async function POST(req: Request) {
     }
 
     // Map scraped fields to our PropertyFormData field names
+    const rawSqm = Number(raw.sqm) || 0
     const mappedData = {
       address: raw.address || "",
       postcode: raw.postcode || "",
@@ -116,6 +117,7 @@ export async function POST(req: Request) {
       propertyType,
       bedrooms: Number(raw.bedrooms) || 3,
       description: raw.description || "",
+      sqm: rawSqm > 0 ? rawSqm : undefined,
     }
 
     console.log("[v0] FLASK PROXY: Mapped scrape data:", mappedData)
diff --git a/components/analyse/analysis-results.tsx b/components/analyse/analysis-results.tsx
index ba80eee..d93944e 100644
--- a/components/analyse/analysis-results.tsx
+++ b/components/analyse/analysis-results.tsx
@@ -167,6 +167,13 @@ export function AnalysisResults({
 
   return (
     <div className="flex flex-col gap-6">
+      {/* Deal Score — top centre, visible immediately */}
+      {parsedAI.score !== null && (
+        <div className="flex flex-col items-center gap-1 py-4">
+          <DealScore score={parsedAI.score} />
+        </div>
+      )}
+
       {/* Key Metrics Grid */}
       <div className="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3">
         <MetricCard
@@ -437,13 +444,6 @@ export function AnalysisResults({
             </div>
           ) : (
             <div className="flex flex-col gap-6">
-              {/* Deal Score */}
-              {parsedAI.score !== null && (
-                <div className="flex justify-center">
-                  <DealScore score={parsedAI.score} />
-                </div>
-              )}
-
               {/* AI Text */}
               <div className="prose prose-sm prose-invert max-w-none">
                 {parsedAI.sections.length > 0 ? (
diff --git a/components/analyse/deal-score.tsx b/components/analyse/deal-score.tsx
index 8ffcc15..8fc7c06 100644
--- a/components/analyse/deal-score.tsx
+++ b/components/analyse/deal-score.tsx
@@ -23,56 +23,60 @@ export function DealScore({ score }: DealScoreProps) {
   const color = getScoreColor(score)
   const label = getScoreLabel(score)
 
-  // SVG arc for the gauge
-  const radius = 70
-  const circumference = Math.PI * radius // half circle
+  // Full circle progress ring
+  const size = 160
+  const strokeWidth = 14
+  const radius = (size - strokeWidth) / 2
+  const circumference = 2 * Math.PI * radius
   const progress = (score / 100) * circumference
+  const cx = size / 2
+  const cy = size / 2
 
   return (
     <div className="flex flex-col items-center gap-3">
-      <svg width="180" height="100" viewBox="0 0 180 100" className="overflow-visible">
-        {/* Background arc */}
-        <path
-          d="M 10 90 A 70 70 0 0 1 170 90"
-          fill="none"
-          stroke="oklch(0.2 0.015 260)"
-          strokeWidth="12"
-          strokeLinecap="round"
-        />
-        {/* Progress arc */}
-        <path
-          d="M 10 90 A 70 70 0 0 1 170 90"
-          fill="none"
-          stroke={color}
-          strokeWidth="12"
-          strokeLinecap="round"
-          strokeDasharray={`${progress} ${circumference}`}
-          className="transition-all duration-1000 ease-out"
-        />
-        {/* Score text */}
-        <text
-          x="90"
-          y="75"
-          textAnchor="middle"
-          className="text-3xl font-bold"
-          fill={color}
+      {/* Ring + centered text overlay */}
+      <div className="relative flex items-center justify-center" style={{ width: size, height: size }}>
+        {/* SVG rotated so progress starts at 12 o'clock */}
+        <svg
+          width={size}
+          height={size}
+          style={{ transform: "rotate(-90deg)" }}
+          className="absolute inset-0"
         >
-          {score}
-        </text>
-        <text
-          x="90"
-          y="95"
-          textAnchor="middle"
-          className="text-xs"
-          fill="oklch(0.6 0.01 260)"
-        >
-          /100
-        </text>
-      </svg>
-      <span
-        className="text-sm font-semibold"
-        style={{ color }}
-      >
+          {/* Background track */}
+          <circle
+            cx={cx}
+            cy={cy}
+            r={radius}
+            fill="none"
+            stroke="oklch(0.2 0.015 260)"
+            strokeWidth={strokeWidth}
+          />
+          {/* Green progress arc */}
+          <circle
+            cx={cx}
+            cy={cy}
+            r={radius}
+            fill="none"
+            stroke={color}
+            strokeWidth={strokeWidth}
+            strokeLinecap="round"
+            strokeDasharray={`${progress} ${circumference}`}
+            className="transition-all duration-1000 ease-out"
+          />
+        </svg>
+
+        {/* Centered score text (not rotated) */}
+        <div className="absolute flex flex-col items-center leading-none">
+          <span className="text-3xl font-bold" style={{ color }}>
+            {score}%
+          </span>
+          <span className="mt-1 text-[11px] text-muted-foreground">/100</span>
+        </div>
+      </div>
+
+      {/* Label below the ring */}
+      <span className="text-sm font-semibold" style={{ color }}>
         {label}
       </span>
     </div>
diff --git a/components/analyse/property-form.tsx b/components/analyse/property-form.tsx
index bdbabe8..07a01dd 100644
--- a/components/analyse/property-form.tsx
+++ b/components/analyse/property-form.tsx
@@ -1,5 +1,6 @@
 "use client"
 
+import { useEffect } from "react"
 import { useForm, Controller } from "react-hook-form"
 import { zodResolver } from "@hookform/resolvers/zod"
 import { z } from "zod"
@@ -16,6 +17,7 @@ import {
 } from "@/components/ui/select"
 import { Loader2, Link2, Info } from "lucide-react"
 import type { PropertyFormData } from "@/lib/types"
+import { estimateRefurbCost } from "@/lib/calculations"
 
 const schema = z.object({
   address: z.string().min(1, "Address is required"),
@@ -130,6 +132,7 @@ export function PropertyForm({ onSubmit, isLoading, defaultValues, prefilled }:
     handleSubmit,
     control,
     watch,
+    setValue,
     formState: { errors },
   } = useForm<PropertyFormData>({
     resolver: zodResolver(schema),
@@ -138,6 +141,24 @@ export function PropertyForm({ onSubmit, isLoading, defaultValues, prefilled }:
 
   const purchaseType = watch("purchaseType")
   const investmentType = watch("investmentType")
+  const sqmValue = watch("sqm")
+  const conditionValue = watch("condition")
+  const propertyTypeValue = watch("propertyType")
+  const postcodeValue = watch("postcode")
+  const refurbValue = watch("refurbishmentBudget")
+
+  // Auto-compute refurb budget from sqm + condition whenever they change,
+  // but only if the user hasn't manually entered a custom refurb amount
+  // (i.e. refurb is still 0 or matches our last auto-estimate).
+  useEffect(() => {
+    if (!sqmValue || sqmValue <= 0) return
+    const estimated = estimateRefurbCost(sqmValue, conditionValue, propertyTypeValue, postcodeValue)
+    // Only overwrite if field is currently 0 or if estimate changed meaningfully
+    if (refurbValue === 0 || refurbValue === undefined) {
+      setValue("refurbishmentBudget", estimated, { shouldDirty: false })
+    }
+    // eslint-disable-next-line react-hooks/exhaustive-deps
+  }, [sqmValue, conditionValue, propertyTypeValue, postcodeValue])
 
   const isR2SA     = investmentType === "r2sa"
   const isHMO      = investmentType === "hmo"
@@ -285,7 +306,7 @@ export function PropertyForm({ onSubmit, isLoading, defaultValues, prefilled }:
                 Additional property (5% SDLT surcharge)
               </Label>
             </div>
-            <FormField label="Refurbishment Budget" hint="Leave 0 if none">
+            <FormField label="Refurbishment Budget" hint={sqmValue ? "Auto-estimated from size & condition — edit to override" : "Enter manually or set sqm + condition above"}>
               <div className="relative">
                 <span className="absolute left-3 top-1/2 -translate-y-1/2 text-sm text-muted-foreground">{"£"}</span>
                 <Input type="number" className="pl-7" {...register("refurbishmentBudget")} />
diff --git a/lib/calculations.ts b/lib/calculations.ts
index 06b4e7b..ae96f79 100644
--- a/lib/calculations.ts
+++ b/lib/calculations.ts
@@ -424,3 +424,43 @@ export function formatCurrency(value: number): string {
 export function formatPercent(value: number): string {
   return `${value.toFixed(2)}%`
 }
+
+/**
+ * Estimate refurbishment cost based on floor area and condition.
+ * Rates are per sq metre, adjusted for London postcodes and property type.
+ *
+ * Condition → cost/sqm (ex-London):
+ *   excellent  →  £0    (move-in ready, no refurb)
+ *   good       →  £40   (cosmetic only: redecorate, carpets)
+ *   fair       →  £100  (medium: kitchen/bathroom update, replastering)
+ *   needs-work →  £185  (heavy: full rewire, new heating, full refurb)
+ */
+export function estimateRefurbCost(
+  sqm: number,
+  condition: string,
+  propertyType: string,
+  postcode?: string
+): number {
+  if (!sqm || sqm <= 0) return 0
+
+  const costPerSqm: Record<string, number> = {
+    excellent: 0,
+    good: 40,
+    fair: 100,
+    "needs-work": 185,
+  }
+
+  const base = costPerSqm[condition] ?? 100
+
+  // Flats are slightly cheaper to refurb (no roof, smaller footprint)
+  const typeMultiplier = propertyType === "flat" ? 0.92 : 1.0
+
+  // London premium (~30%) based on postcode prefix
+  const londonPrefixes = ["E", "EC", "N", "NW", "SE", "SW", "W", "WC", "BR", "CR", "DA", "EN", "HA", "IG", "KT", "RM", "SM", "TW", "UB", "WD"]
+  const isLondon = postcode
+    ? londonPrefixes.some((p) => postcode.toUpperCase().startsWith(p))
+    : false
+  const areaMultiplier = isLondon ? 1.3 : 1.0
+
+  return Math.round(sqm * base * typeMultiplier * areaMultiplier)
+}
-- 
2.43.0

